name: Build-Win11PE-Factory

on:
  workflow_dispatch:

jobs:
  build:
   # runs-on: ubuntu-latest
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # ---------------------------------------------------------
    # 1. 安装 Linux 构建工具
    # ---------------------------------------------------------

    - name: Install required tools
      run: |
        sudo apt update
        sudo apt install -y p7zip-full xorriso
        curl -L -o wimlib.deb "http://ftp.us.debian.org/debian/pool/main/w/wimlib/wimtools_1.14.4-1_amd64.deb"
        sudo dpkg -i wimlib.deb || sudo apt --fix-broken install -y
  # ---------------------------------------------------------
    # 2. 创建构建目录
    # ---------------------------------------------------------
    - name: Prepare build directories
      run: |
        mkdir -p build/iso
        mkdir -p build/mount
        mkdir -p build/extract
        mkdir -p build/tools
        mkdir -p build/drivers
        mkdir -p build/fonts
        mkdir -p build/winxshell
        mkdir -p build/browser
        mkdir -p build/sdi

    # ---------------------------------------------------------
    # 3. 下载 Win11 ISO（官方静态直链）
    # ---------------------------------------------------------
    - name: Download Windows 11 ISO via UUP dump
      run: |
        curl -L -o uup.zip "https://github.com/uup-dump/uup-dump/releases/latest/download/uupdump_linux.zip"
        7z x uup.zip -ouup
        bash uup/uup_download_linux.sh -l zh-cn -r 23H2 -e professional -o iso
        mv *.iso win11.iso
    
    # ---------------------------------------------------------
    # 4. 解压 ISO
    # ---------------------------------------------------------
    - name: Extract ISO
      run: |
        7z x win11.iso -obuild/extract

    # ---------------------------------------------------------
    # 5. 提取 boot.wim
    # ---------------------------------------------------------
    - name: Extract boot.wim
      run: |
        cp build/extract/sources/boot.wim build/boot.wim

    # ---------------------------------------------------------
    # 6. 下载 WinXShell（任务栏 + 开始菜单）
    # ---------------------------------------------------------
    - name: Download WinXShell
      run: |
        curl -L -o winxshell.zip "https://github.com/pebakery/winxshell/releases/latest/download/WinXShell.zip"
        7z x winxshell.zip -obuild/winxshell

    # ---------------------------------------------------------
    # 7. 挂载 boot.wim（wimlib）
    # ---------------------------------------------------------
    - name: Mount boot.wim
      run: |
        sudo wimlib-imagex mount build/boot.wim 1 build/mount

    # ---------------------------------------------------------
    # 8. 注入 WinXShell
    # ---------------------------------------------------------
    - name: Inject WinXShell
      run: |
        mkdir -p build/mount/Windows/System32/WinXShell
        cp -r build/winxshell/* build/mount/Windows/System32/WinXShell/

    # ---------------------------------------------------------
    # 9. 替换 startnet.cmd（启动 WinXShell + 设置分辨率）
    # ---------------------------------------------------------
    - name: Replace startnet.cmd
      run: |
        cat << 'EOF' > build/mount/Windows/System32/startnet.cmd
        wpeinit
        wmic path Win32_VideoController call SetDisplayConfig 1024,768,32
        start "" X:\Windows\System32\WinXShell\WinXShell.exe
        EOF

    # ---------------------------------------------------------
    # 10. 生成 WinXShell 菜单（工具箱）
    # ---------------------------------------------------------
    - name: Generate WinXShell Menu
      run: |
        cat << 'EOF' > build/mount/Windows/System32/WinXShell/Menu.xml
        <Menu>
          <Item Name="DiskGenius" Path="X:\ProgramFiles\Tools\dg\DiskGenius.exe" />
          <Item Name="7-Zip" Path="X:\ProgramFiles\Tools\7z\7zFM.exe" />
          <Item Name="CMD" Path="X:\Windows\System32\cmd.exe" />
          <Item Name="PowerShell" Path="X:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe" />
          <Item Name="Chromium" Path="X:\ProgramFiles\Tools\browser\chrome.exe" />
        </Menu>
        EOF

    # ---------------------------------------------------------
    # 11. 下载 Chromium 浏览器（Thorium Portable）
    # ---------------------------------------------------------
    - name: Download Chromium Browser
      run: |
        curl -L -o browser.zip "https://github.com/Alex313031/Thorium/releases/latest/download/thorium-portable-win64.zip"
        7z x browser.zip -obuild/browser

    # ---------------------------------------------------------
    # 12. 下载 SDI 驱动包（自动更新驱动）
    # ---------------------------------------------------------
    - name: Download SDI Driver Pack
      run: |
        curl -L -o sdi.zip "https://sdi-tool.org/releases/sdi-lite.zip"
        7z x sdi.zip -obuild/sdi

    # ---------------------------------------------------------
    # 13. 从 Win11 ISO 提取 NVMe / USB3 驱动
    # ---------------------------------------------------------
    - name: Extract NVMe and USB3 drivers
      run: |
        mkdir -p build/drivers/nvme
        mkdir -p build/drivers/usb3
        cp -r build/extract/Windows/System32/DriverStore/FileRepository/stornvme.inf* build/drivers/nvme/ || true
        cp -r build/extract/Windows/System32/DriverStore/FileRepository/iusb3hub.inf* build/drivers/usb3/ || true
        cp -r build/extract/Windows/System32/DriverStore/FileRepository/iusb3xhc.inf* build/drivers/usb3/ || true

    # ---------------------------------------------------------
    # 14. 注入中文字体
    # ---------------------------------------------------------
    - name: Inject Chinese Fonts
      run: |
        cp build/extract/Windows/Fonts/msyh.ttc build/mount/Windows/Fonts/ || true
        cp build/extract/Windows/Fonts/simhei.ttf build/mount/Windows/Fonts/ || true

    # ---------------------------------------------------------
    # 15. 注入浏览器
    # ---------------------------------------------------------
    - name: Inject Chromium Browser
      run: |
        mkdir -p build/mount/ProgramFiles/Tools/browser
        cp -r build/browser/* build/mount/ProgramFiles/Tools/browser/

    # ---------------------------------------------------------
    # 16. 注入 DiskGenius / 7-Zip
    # ---------------------------------------------------------
    - name: Inject Tools
      run: |
        mkdir -p build/mount/ProgramFiles/Tools/dg
        mkdir -p build/mount/ProgramFiles/Tools/7z

        curl -L -o dg.zip "https://download.diskgenius.com/dg.zip"
        7z x dg.zip -obuild/dg
        cp -r build/dg/* build/mount/ProgramFiles/Tools/dg/

        curl -L -o 7z.zip "https://www.7-zip.org/a/7z2408-extra.7z"
        7z x 7z.zip -obuild/7z
        cp -r build/7z/* build/mount/ProgramFiles/Tools/7z/

    # ---------------------------------------------------------
    # 17. 注入 SDI 驱动
    # ---------------------------------------------------------
    - name: Inject SDI Drivers
      run: |
        mkdir -p build/mount/ProgramFiles/Tools/sdi
        cp -r build/sdi/* build/mount/ProgramFiles/Tools/sdi/

    # ---------------------------------------------------------
    # 18. 注入 Win11 网络组件
    # ---------------------------------------------------------
    - name: Inject Network Components
      run: |
        cp -r build/extract/Windows/System32/winhttp.dll build/mount/Windows/System32/ || true
        cp -r build/extract/Windows/System32/webio.dll build/mount/Windows/System32/ || true
        cp -r build/extract/Windows/System32/wininet.dll build/mount/Windows/System32/ || true
        cp -r build/extract/Windows/System32/urlmon.dll build/mount/Windows/System32/ || true
        cp -r build/extract/Windows/System32/mswsock.dll build/mount/Windows/System32/ || true

    # ---------------------------------------------------------
    # 19. 提交 boot.wim 修改
    # ---------------------------------------------------------
    - name: Commit boot.wim changes
      run: |
        sudo wimlib-imagex unmount build/mount --commit

    # ---------------------------------------------------------
    # 20. 创建 Lite / Full 目录
    # ---------------------------------------------------------
    - name: Prepare Lite and Full directories
      run: |
        mkdir -p build/lite/sources
        mkdir -p build/full/sources
        cp build/boot.wim build/lite/sources/boot.wim
        cp build/boot.wim build/full/sources/boot.wim

    # ---------------------------------------------------------
    # 21. Lite 版（删除浏览器和 SDI）
    # ---------------------------------------------------------
    - name: Build Lite boot.wim
      run: |
        sudo wimlib-imagex mount build/lite/sources/boot.wim 1 build/mount
        rm -rf build/mount/ProgramFiles/Tools/browser || true
        rm -rf build/mount/ProgramFiles/Tools/sdi || true
        sudo wimlib-imagex unmount build/mount --commit

    # ---------------------------------------------------------
    # 22. Full 版（保留全部内容）
    # ---------------------------------------------------------
    - name: Build Full boot.wim
      run: |
        sudo wimlib-imagex mount build/full/sources/boot.wim 1 build/mount
        sudo wimlib-imagex unmount build/mount --commit

    # ---------------------------------------------------------
    # 23. 构建 Lite ISO（BIOS + UEFI 双启动）
    # ---------------------------------------------------------
    - name: Build Lite ISO
      run: |
        mkdir -p build/lite/iso
        cp -r build/extract/* build/lite/iso/
        cp build/lite/sources/boot.wim build/lite/iso/sources/
        xorriso -as mkisofs \
          -iso-level 3 \
          -o Win11PE-Lite.iso \
          -b boot/etfsboot.com \
          -no-emul-boot \
          -boot-load-size 8 \
          -eltorito-alt-boot \
          -e efi/microsoft/boot/efisys.bin \
          -no-emul-boot \
          build/lite/iso

    # ---------------------------------------------------------
    # 24. 构建 Full ISO（BIOS + UEFI 双启动）
    # ---------------------------------------------------------
    - name: Build Full ISO
      run: |
        mkdir -p build/full/iso
        cp -r build/extract/* build/full/iso/
        cp build/full/sources/boot.wim build/full/iso/sources/
        xorriso -as mkisofs \
          -iso-level 3 \
          -o Win11PE-Full.iso \
          -b boot/etfsboot.com \
          -no-emul-boot \
          -boot-load-size 8 \
          -eltorito-alt-boot \
          -e efi/microsoft/boot/efisys.bin \
          -no-emul-boot \
          build/full/iso

    # ---------------------------------------------------------
    # 25. 上传到 Release
    # ---------------------------------------------------------
    - name: Upload ISOs to Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          Win11PE-Lite.iso
          Win11PE-Full.iso
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}